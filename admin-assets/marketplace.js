/*** Marketplace JavaScript - Soft UI Dashboard* * @package Base47_HTML_Editor*/(function($) {'use strict';// Statelet templates = [];let currentFilters = {search: '',category: 'all',type: 'all',sort: 'popular'};let previewTemplateId = null;// DOM Elementsconst $templatesGrid = $('#templates-grid');const $templatesLoading = $('#templates-loading');const $templatesEmpty = $('#templates-empty');const $templatesCount = $('#templates-count');const $searchInput = $('#template-search');const $categorySelect = $('#template-category');const $typeSelect = $('#template-type');const $sortSelect = $('#template-sort');const $refreshBtn = $('#refresh-templates');const $previewModal = $('#preview-modal');/*** Initialize the marketplace*/function init() {bindEvents();loadTemplates();}/*** Bind event listeners*/function bindEvents() {// Filter events$searchInput.on('input', debounce(function() {currentFilters.search = $(this).val();filterAndRenderTemplates();}, 300));$categorySelect.on('change', function() {currentFilters.category = $(this).val();filterAndRenderTemplates();});$typeSelect.on('change', function() {currentFilters.type = $(this).val();filterAndRenderTemplates();});$sortSelect.on('change', function() {currentFilters.sort = $(this).val();filterAndRenderTemplates();});$refreshBtn.on('click', function() {loadTemplates();});// Template card events (delegated)$templatesGrid.on('click', '.btn-install', function() {const templateId = $(this).data('template-id');installTemplate(templateId, $(this));});$templatesGrid.on('click', '.btn-preview', function() {const templateId = $(this).data('template-id');openPreview(templateId);});// Preview modal events$previewModal.find('.preview-backdrop, #preview-close-btn').on('click', closePreview);$previewModal.find('.device-btn').on('click', function() {const device = $(this).data('device');switchDevice(device);});$('#preview-install-btn').on('click', function() {if (previewTemplateId) {installTemplate(previewTemplateId, $(this));}});// Close modal on ESC$(document).on('keydown', function(e) {if (e.key === 'Escape' && $previewModal.is(':visible')) {closePreview();}});}/*** Load templates via AJAX*/function loadTemplates() {showLoading();$.ajax({url: base47HeAdmin.ajaxUrl,type: 'POST',data: {action: 'base47_he_load_marketplace',nonce: base47HeAdmin.nonce,filters: currentFilters},success: function(response) {if (response.success && response.data.templates) {templates = response.data.templates;$templatesCount.text(templates.length);filterAndRenderTemplates();} else {showError('Failed to load templates');}},error: function() {showError('Network error. Please try again.');}});}/*** Filter and render templates*/function filterAndRenderTemplates() {let filtered = [...templates];// Search filterif (currentFilters.search) {const search = currentFilters.search.toLowerCase();filtered = filtered.filter(t => t.name.toLowerCase().includes(search) ||t.description.toLowerCase().includes(search) ||t.category.toLowerCase().includes(search));}// Category filterif (currentFilters.category !== 'all') {filtered = filtered.filter(t => t.category.toLowerCase().replace(/[- ]/g, '') === currentFilters.category.replace('-', ''));}// Type filterif (currentFilters.type !== 'all') {filtered = filtered.filter(t => t.type === currentFilters.type);}// Sortswitch (currentFilters.sort) {case 'newest':filtered.reverse();break;case 'rating':filtered.sort((a, b) => b.rating - a.rating);break;case 'downloads':filtered.sort((a, b) => b.downloads - a.downloads);break;case 'popular':default:filtered.sort((a, b) => (b.downloads * b.rating) - (a.downloads * a.rating));break;}renderTemplates(filtered);}/*** Render templates to the grid*/function renderTemplates(templateList) {hideLoading();if (templateList.length === 0) {$templatesGrid.hide();$templatesEmpty.show();return;}$templatesEmpty.hide();$templatesGrid.show();const html = templateList.map(template => createTemplateCard(template)).join('');$templatesGrid.html(html);}/*** Create HTML for a template card*/function createTemplateCard(template) {const badgeClass = template.type === 'free' ? 'badge-free' : 'badge-premium';const badgeText = template.type === 'free' ? 'Free' : template.price;const thumbnailHtml = template.thumbnail.startsWith('<svg') ? template.thumbnail : `<img src="${escapeHtml(template.thumbnail)}" alt="${escapeHtml(template.name)}">`;return `<div class="template-card" data-template-id="${escapeHtml(template.id)}"><div class="template-thumbnail">${thumbnailHtml}<span class="badge ${badgeClass}">${escapeHtml(badgeText)}</span><div class="template-overlay"><button type="button" class="btn btn-preview" data-template-id="${escapeHtml(template.id)}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>Preview</button></div></div><div class="template-content"><p class="template-category">${escapeHtml(template.category)}</p><h3 class="template-name">${escapeHtml(template.name)}</h3><p class="template-description">${escapeHtml(template.description)}</p><div class="template-stats"><div class="template-rating"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg><span>${template.rating}</span><span class="reviews">(${template.reviews})</span></div><div class="template-downloads"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg><span>${formatNumber(template.downloads)}</span></div></div><div class="template-actions"><button type="button" class="btn btn-primary btn-install" data-template-id="${escapeHtml(template.id)}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>Install</button><button type="button" class="btn btn-secondary btn-preview" data-template-id="${escapeHtml(template.id)}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg></button></div></div></div>`;}/*** Install a template*/function installTemplate(templateId, $button) {const $btn = $button;const originalHtml = $btn.html();$btn.addClass('loading').html(`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>Installing...`);$.ajax({url: base47HeAdmin.ajaxUrl,type: 'POST',data: {action: 'base47_he_install_marketplace_template',nonce: base47HeAdmin.nonce,template_id: templateId},success: function(response) {if (response.success) {$btn.removeClass('loading').html(`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>Installed!`);showNotification('success', response.data.message || 'Template installed successfully!');// Redirect after a delay if URL providedif (response.data.redirect_url) {setTimeout(function() {window.location.href = response.data.redirect_url;}, 1500);}} else {$btn.removeClass('loading').html(originalHtml);showNotification('error', response.data?.message || 'Installation failed');}},error: function() {$btn.removeClass('loading').html(originalHtml);showNotification('error', 'Network error. Please try again.');}});}/*** Open preview modal*/function openPreview(templateId) {const template = templates.find(t => t.id === templateId);if (!template) return;previewTemplateId = templateId;// Update modal content$('#preview-template-name').text(template.name);$('#preview-template-badge').removeClass('badge-free badge-premium').addClass(template.type === 'free' ? 'badge-free' : 'badge-premium').text(template.type === 'free' ? 'Free' : template.price);// Reset device to desktopswitchDevice('desktop');// Load previewloadPreviewUrl(templateId);// Show modal$previewModal.fadeIn(200);$('body').css('overflow', 'hidden');}/*** Load preview URL via AJAX*/function loadPreviewUrl(templateId) {const $iframe = $('#preview-iframe');$iframe.attr('src', 'about:blank');$.ajax({url: base47HeAdmin.ajaxUrl,type: 'POST',data: {action: 'base47_he_get_template_preview',nonce: base47HeAdmin.nonce,template_id: templateId},success: function(response) {if (response.success && response.data.preview_url) {$iframe.attr('src', response.data.preview_url);}}});}/*** Close preview modal*/function closePreview() {$previewModal.fadeOut(200);$('body').css('overflow', '');previewTemplateId = null;$('#preview-iframe').attr('src', 'about:blank');}/*** Switch preview device*/function switchDevice(device) {const $wrapper = $('#preview-frame-wrapper');const $buttons = $previewModal.find('.device-btn');$buttons.removeClass('active');$buttons.filter(`[data-device="${device}"]`).addClass('active');$wrapper.removeClass('device-desktop device-tablet device-mobile');$wrapper.addClass(`device-${device}`);}/*** Show loading state*/function showLoading() {$templatesGrid.hide();$templatesEmpty.hide();$templatesLoading.show();}/*** Hide loading state*/function hideLoading() {$templatesLoading.hide();}/*** Show error message*/function showError(message) {hideLoading();showNotification('error', message);}/*** Show notification*/function showNotification(type, message) {// If you have a notification system, use it here// For now, we'll use a simple alert or consoleif (type === 'error') {console.error('Marketplace:', message);alert(message);} else {console.log('Marketplace:', message);}}/*** Utility: Debounce function*/function debounce(func, wait) {let timeout;return function executedFunction(...args) {const later = () => {clearTimeout(timeout);func.apply(this, args);};clearTimeout(timeout);timeout = setTimeout(later, wait);};}/*** Utility: Escape HTML*/function escapeHtml(text) {if (!text) return '';const div = document.createElement('div');div.textContent = text;return div.innerHTML;}/*** Utility: Format number (1250 -> 1.2K)*/function formatNumber(num) {if (num >= 1000000) {return (num / 1000000).toFixed(1) + 'M';}if (num >= 1000) {return (num / 1000).toFixed(1) + 'K';}return num.toString();}// Initialize on document ready$(document).ready(init);})(jQuery);
